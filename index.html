<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEMBERS DAYï¼ˆ2025ï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --card2:#0f1730; --text:#eef3ff; --muted:#a9b4d0;
      --line:rgba(255,255,255,.10); --ok:#34d399; --warn:#fbbf24; --bad:#fb7185; --btn:#3b82f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 800px at 10% 10%, #1b2a57 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap}
    h1{margin:0; font-size:22px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(59,130,246,.7); box-shadow: 0 0 0 3px rgba(59,130,246,.18)}
    .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      padding:12px; border-radius:14px; background: rgba(0,0,0,.18);
      border:1px solid var(--line);
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:18px; margin-top:6px}
    .v.ok{color:var(--ok)} .v.bad{color:var(--bad)} .v.warn{color:var(--warn)}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0; border-radius:12px; padding:10px 12px; cursor:pointer; color:white;
      background: var(--btn);
    }
    button.secondary{background: rgba(255,255,255,.12)}
    button.danger{background: rgba(251,113,133,.85)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .section-title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 10px}
    .section-title h2{margin:0; font-size:15px}
    .pill{font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px}
    .products{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
    @media (max-width:520px){ .products{grid-template-columns:1fr} }
    .prod{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background: rgba(0,0,0,.18);
      display:flex; flex-direction:column; gap:10px;
    }
    .prod .name{font-weight:600}
    .prod .meta{display:flex; justify-content:space-between; color:var(--muted); font-size:12px}
    .prod .actions{display:flex; gap:8px; align-items:center}
    .qty{
      width:70px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
    }
    .cart{display:flex; flex-direction:column; gap:10px;}
    .cart-item{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px; background: rgba(0,0,0,.18);
    }
    .cart-item .left{flex:1}
    .cart-item .small{color:var(--muted); font-size:12px; margin-top:4px}
    .cart-item .right{text-align:right}
    .cart-item .rm{color:var(--muted); font-size:12px}
    .cart-item .remove{margin-top:6px; background: rgba(255,255,255,.12)}
    .note{color:var(--muted); font-size:12px; line-height:1.45}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .toast{
      position: fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px; border-radius:999px; color:var(--text);
      font-size:13px; display:none; z-index:99;
      max-width: calc(100% - 24px);
    }
    dialog{
      border:1px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text);
      width:min(720px, calc(100% - 24px));
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .modal-head{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .modal-head h3{margin:0; font-size:16px}
    .modal-body{margin-top:10px}
    .summary{
      border:1px solid var(--line); border-radius:14px; padding:12px; background: rgba(0,0,0,.20);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
  <div>
    <img src="./images/logo.png" 
         alt="è¡¥ä¹ ä¸­å¿ƒ Logo"
         style="height:80px; margin-bottom:8px;">
         
    <h1>ğŸ 2025 MEMBERS DAY </h1>
    <div class="sub">è¾“å…¥ä½ çš„èµ„æ–™ â†’ é€‰æ‹©å•†å“ â†’ è´­ç‰©è½¦ â†’ æäº¤å‰ç¡®è®¤è®¢å•</div>
  </div>
  <div class="pill">SUPER MODERN EDUCATION GROUP</div>
</header>


    <div class="grid">
      <section class="card">
        <div class="section-title">
          <h2>ğŸ‘©â€ğŸ“ å­¦ç”Ÿèµ„æ–™</h2>
          <span class="pill">å¿…å¡«ï¼šåå­— / å¹´çº§(2025) / ç§¯åˆ†</span>
        </div>

        <div class="row">
          <div>
            <label>å­¦ç”Ÿåå­—</label>
            <input id="studentName" placeholder="ä¾‹å¦‚ï¼šé™ˆå°ç¾ / å¼ å¯çˆ± / Jason / å°æ˜" />
          </div>
          <div>
            <label>å¹´çº§ / FORMï¼ˆ2025ï¼‰</label>
            <select id="studentLevel"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>ç§¯åˆ†åˆ†æ•°</label>
            <input id="studentPoints" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š120" />
          </div>
          <div>
            <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
            <input id="studentNote" placeholder="ä¾‹å¦‚ï¼šæœ‰éœ€è¦æ‰å¡«â€¦" />
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">å¯ç”¨ç§¯åˆ†</div>
            <div class="v ok" id="kpiAvailable">0</div>
          </div>
          <div class="kpi">
            <div class="t">å·²é€‰å•†å“æ€»ç§¯åˆ†</div>
            <div class="v" id="kpiSpent">0</div>
          </div>
          <div class="kpi">
            <div class="t">é€‰æ‹©åå‰©ä½™ç§¯åˆ†</div>
            <div class="v" id="kpiRemaining">0</div>
          </div>
        </div>

        <div class="toolbar">
          <button class="secondary" id="btnSave">ğŸ’¾ ä¿å­˜å­¦ç”Ÿèµ„æ–™</button>
          <button class="secondary" id="btnLoad">ğŸ“¥ è¯»å–ä¸Šæ¬¡èµ„æ–™</button>
          <button class="danger" id="btnReset">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨</button>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>ğŸ›ï¸ å…‘æ¢å•†å“é€‰é¡¹</h2>
          <span class="pill" id="prodHint">ç‚¹â€œåŠ å…¥è´­ç‰©è½¦â€</span>
        </div>

        <div class="products" id="productList"></div>

        <p class="note" style="margin-top:12px">
          âœ… è§„åˆ™ï¼š<b>é€‰çš„å•†å“æ€»ç§¯åˆ†ä¸èƒ½è¶…è¿‡è‡ªå·±çš„ç§¯åˆ†</b>ã€‚<br/>
      </p>
      </section>

      <aside class="card">
        <div class="section-title">
          <h2>ğŸ§º è´­ç‰©è½¦</h2>
          <span class="pill" id="cartCount">0 ä»¶</span>
        </div>

        <div class="cart" id="cart"></div>

        <div class="divider"></div>

        <div class="kpis" style="grid-template-columns:1fr">
          <div class="kpi">
            <div class="t">æäº¤å‰ç¡®è®¤è®¢å•</div>
            <div class="note" style="margin-top:6px">
              ç‚¹å‡»ä¸‹æ–¹ã€Œç¡®è®¤è®¢å•ã€ä¼šå¼¹å‡ºç¡®è®¤çª—å£ã€‚ç¡®è®¤æ— è¯¯åæ‰èƒ½æäº¤ã€‚
            </div>
          </div>
        </div>

        <div class="toolbar" style="margin-top:12px">
          <button id="btnReview">âœ… ç¡®è®¤è®¢å•</button>
          <button class="secondary" id="btnCopy" disabled>ğŸ“‹ å¤åˆ¶è®¢å•æ‘˜è¦</button>
        </div>

        <p class="note" style="margin-top:10px">
         </p>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <dialog id="dlg">
    <form method="dialog">
      <div class="modal-head">
        <h3>ğŸ§¾ è¯·ç¡®è®¤è®¢å•</h3>
        <button class="secondary" value="cancel">âœ– å…³é—­</button>
      </div>
      <div class="modal-body">
        <div class="note" id="confirmMeta"></div>
        <div class="divider"></div>
        <div class="summary" id="confirmSummary"></div>
        <div class="divider"></div>
        <div class="toolbar">
          <button id="btnSubmit" value="default">ğŸš€ æäº¤è®¢å•</button>
          <button class="secondary" value="cancel">è¿”å›ä¿®æ”¹</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // ====== 1) å•†å“æ¸…å•ï¼šä½ å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹ï¼ˆå›¾ç‰‡ç»Ÿä¸€æ”¾ Desktop/images/ï¼‰ ======
    // è§„åˆ™ï¼šindex.html åœ¨ Desktopï¼›å›¾ç‰‡åœ¨ Desktop/images/
    const PRODUCTS = [
 { id:"p1", name:"ğŸ‘”ç°ä»£æ½®æœ", cost:300,img:"images/ç°ä»£æ½®æœ.png" },
 { id:"p2", name:"ğŸ’«ç‹¬å®¶ç°ä»£å¸†å¸ƒè¢‹", cost:300,img:"images/ç‹¬å®¶ç°ä»£å¸†å¸ƒè¢‹.png" },
 { id:"p3", name:"ğŸ”…ç®€çº¦å¸†å¸ƒè¢‹", cost:280,img:"images/ç®€çº¦å¸†å¸ƒåŒ….png" },
 { id:"p4", name:"ğŸœé…¸è¾£ç²‰", cost:230,img:"images/é…¸è¾£ç²‰.png" },
 { id:"p5", name:"ğŸœèºè›³ç²‰", cost:230,img:"images/èºè›³ç²‰.png" },
 { id:"p6", name:"ğŸŸå°è¾£æ¡", cost:50,img:"images/å°è¾£æ¡.png" },
 { id:"p7", name:"ğŸ¦‘é­”èŠ‹çˆ½", cost:50,img:"images/é­”èŠ‹çˆ½.png" },
 { id:"p8", name:"ğŸ¥–èŠ±èŠ±è‚ å­", cost:50,img:"images/èŠ±èŠ±è‚ å­.png" },
{ id:"p9", name:"ğŸŸçƒ¤ç”˜è–¯-å°è–¯æ¡", cost:50,img:"images/çƒ¤ç”˜è–¯-å°è–¯æ¡.png" },
{ id:"p10", name:"ğŸŸLAYSè–¯ç‰‡", cost:80,img:"images/LAYSè–¯ç‰‡.png" },
{ id:"p11", name:"ğŸ¦€æ‰‹æ’•èŸ¹æŸ³", cost:50,img:"images/æ‰‹æ’•èŸ¹æŸ³.png" },
{ id:"p12", name:"ğŸ™é¦™è„†æµ·è‹”ï¼ˆ5åŒ…ï¼‰", cost:30,img:"images/é¦™è„†æµ·è‹”ï¼ˆ5åŒ…ï¼‰.png" },
{ id:"p13", name:"ğŸ¥œæ¯æ—¥åšæœ", cost:50,img:"images/æ¯æ—¥åšæœ.png" },
{ id:"p14", name:"ğŸ¬MINI TIC TAC", cost:50,img:"images/MINI TIC TAC.png" },
{ id:"p15", name:"ğŸ“å®‰æ…•å¸Œ", cost:280,img: "images/å®‰æ…•å¸Œ.png",options: ["åŸå‘³", "è‰è“å‘³"]},
{ id:"p16", name:"ğŸ¹å¿«ä¹è‚¥ä»”æ°´-å…ƒæ°”æ£®æ—", cost:200,img:"images/å¿«ä¹è‚¥ä»”æ°´-å…ƒæ°”æ£®æ—.png" },
{ id:"p17", name:"ğŸ”–CUTE STICKY NOTE", cost:200,img:"images/CUTE STICKY NOTE.png" },
{ id:"p18", name:"ğŸ·OLD STYLE STICKY NOTE", cost:180,img:"images/OLD STYLE STICKY NOTE.png" },
{ id:"p19", name:"ğŸƒä½ è¯´å•¥ä¾¿åˆ©è´´", cost:180,img:"images/ä½ è¯´å•¥ä¾¿åˆ©è´´.png" },
{ id:"p20", name:"âœ¨é€æ˜STICKY NOTE", cost:180,img:"images/é€æ˜STICKY NOTE.png" },
{ id:"p21", name:"ğŸ–ŠINSä¿®æ­£å¸¦", cost:150,img:"images/INSä¿®æ­£å¸¦.png" },
{ id:"p22", name:"ğŸ INSé«˜é¢œå€¼ç¬”-å²åŠªæ¯”", cost:150,img:"images/INSé«˜é¢œå€¼ç¬”-å²åŠªæ¯”.png" },
{ id:"p23", name:"ğŸ»INSé«˜é¢œå€¼ç¬”-å°ç†Šå¤å¤", cost:150,img:"images/INSé«˜é¢œå€¼ç¬”-å°ç†Šå¤å¤.png" },
{ id:"p24", name:"âœå†™ä¸å®Œçš„é“…ç¬”", cost:150,img:"images/å†™ä¸å®Œçš„é“…ç¬”.png" },
{ id:"p25", name:"ğŸ“‚æ‹¿æ¥å¤¹OPTçš„ä¸‰è§’å¤¹", cost:35,img:"images/æ‹¿æ¥å¤¹OPTçš„ä¸‰è§’å¤¹.png" },
{ id:"p26", name:"ğŸ“•å°å°è®°äº‹æœ¬", cost:200,img:"images/å°å°è®°äº‹æœ¬.png" },
{ id:"p27", name:"ğŸ–æˆ‘æ˜¯æ”¯æ©¡çš®æ“¦", cost:180,img:"images/æˆ‘æ˜¯æ”¯æ©¡çš®æ“¦.png" },
{ id:"p28", name:"ğŸ“æ•°å­¦è¯¾å¿…ç”¨åœ†è§„", cost:180,img:"images/æ•°å­¦è¯¾å¿…ç”¨åœ†è§„.png" },
{ id:"p29", name:"ğŸ“æ²¡å°ºè¯·æ¥æ¢", cost:100, img:"images/æ²¡å°ºè¯·æ¥æ¢.png" },
{ id:"p30", name:"ğŸ—ƒç®€çº¦é“…ç¬”ç›’", cost:120,img:"images/ç®€çº¦é“…ç¬”ç›’.png" },
{ id:"p31", name:"ğŸ–Œç³–æœè‰²è§å…‰ç¬”ï¼ˆæ”¯ï¼‰", cost:80,img:"images/ç³–æœè‰²è§å…‰ç¬”ï¼ˆæ”¯ï¼‰.png" },

  ];


    // ====== 2) å¹´çº§/FORMï¼ˆæ³¨æ˜2025ï¼‰ ======
    const LEVELS_2025 = [
      "2025ï½œForm 1", "2025ï½œForm 2", "2025ï½œForm 3",
      "2025ï½œForm 4", "2025ï½œForm 5",
    ];

    // ====== 3) çŠ¶æ€ ======
    const state = {
      student: { name:"", level: LEVELS_2025[0], points: 0, note:"" },
      cart: new Map(), // id -> qty
      lastOrderText: ""
    };

    // ====== 4) DOM ======
    const $ = (id) => document.getElementById(id);
    const studentName = $("studentName");
    const studentLevel = $("studentLevel");
    const studentPoints = $("studentPoints");
    const studentNote = $("studentNote");

    const kpiAvailable = $("kpiAvailable");
    const kpiSpent = $("kpiSpent");
    const kpiRemaining = $("kpiRemaining");

    const productList = $("productList");
    const cartEl = $("cart");
    const cartCount = $("cartCount");

    const btnSave = $("btnSave");
    const btnLoad = $("btnLoad");
    const btnReset = $("btnReset");
    const btnReview = $("btnReview");
    const btnCopy = $("btnCopy");

    const dlg = $("dlg");
    const confirmMeta = $("confirmMeta");
    const confirmSummary = $("confirmSummary");
    const btnSubmit = $("btnSubmit");

    const toast = $("toast");

    // ====== helpers ======
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display="none", 2200);
    }

    function money(n){ return Number(n||0).toString(); }

    function getStudentPoints(){
      const v = Number(studentPoints.value);
      return Number.isFinite(v) && v >= 0 ? Math.floor(v) : 0;
    }
// 
function safeImg(src){
  if(!src) return "";
  return src.split("/").map(encodeURIComponent).join("/");
}

    function cartItems(){
      const items = [];
      for(const [id, qty] of state.cart.entries()){
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) continue;
        items.push({ ...p, qty, subtotal: p.cost * qty });
      }
      return items;
    }

    function cartTotal(){
      return cartItems().reduce((s,it)=> s + it.subtotal, 0);
    }

    function remainingPoints(){
      return getStudentPoints() - cartTotal();
    }

    function validateStudent(){
      const name = studentName.value.trim();
      const pts = getStudentPoints();
      if(!name) return { ok:false, msg:"è¯·å…ˆå¡«å†™å­¦ç”Ÿåå­—ã€‚" };
      if(!studentLevel.value) return { ok:false, msg:"è¯·é€‰æ‹©å¹´çº§/FORMï¼ˆ2025ï¼‰ã€‚" };
      if(pts <= 0) return { ok:false, msg:"ç§¯åˆ†åˆ†æ•°éœ€è¦å¤§äº 0ã€‚" };
      return { ok:true };
    }

    function canAdd(cost, qtyToAdd){
      const newTotal = cartTotal() + cost * qtyToAdd;
      return newTotal <= getStudentPoints();
    }

    // ====== render ======
    function renderLevels(){
      studentLevel.innerHTML = "";
      LEVELS_2025.forEach(l=>{
        const opt = document.createElement("option");
        opt.value = l; opt.textContent = l;
        studentLevel.appendChild(opt);
      });
      studentLevel.value = state.student.level;
    }

    function renderProducts(){
      productList.innerHTML = "";
      PRODUCTS.forEach(p=>{
        const card = document.createElement("div");
        card.className = "prod";

        // âœ… æ³¨æ„ï¼šåªæœ‰è¿™ä¸€æ®µæ¨¡æ¿ï¼ˆä¹‹å‰ä½ å¤šè´´äº†ä¸€æ®µå¯¼è‡´ JS ç‚¸æ‰ï¼‰
        card.innerHTML = `
          <div style="display:flex; gap:12px; align-items:center">
           <img src="${p.img ? safeImg(p.img) : ''}"
     alt=""
     style="width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid var(--line);background:rgba(0,0,0,.2)"
     onerror="this.onerror=null; this.src='images/placeholder.png';">


            <div style="flex:1">
              <div class="name">${p.name}</div>
              <div class="meta">
                <span><b>${money(p.cost)}</b> pts</span>
              </div> 
${p.options ? `
  <select class="optionSelect" style="
    margin-top:6px;
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.2);
    color:var(--text);
  ">
    <option value="">è¯·é€‰æ‹©å†…å®¹</option>
    ${p.options.map(o => `<option value="${o}">${o}</option>`).join("")}
  </select>
` : ""}

            </div>
          </div>

          <div class="actions">
            <input class="qty" type="number" min="1" step="1" value="1" aria-label="æ•°é‡" />
            <button type="button">â• åŠ å…¥è´­ç‰©è½¦</button>
          </div>

          <div class="note">æç¤ºï¼šæ€»ç§¯åˆ†ä¸èƒ½è¶…è¿‡ä½ çš„ç§¯åˆ†ã€‚</div>
        `;

        const qtyInput = card.querySelector("input.qty");
        const addBtn = card.querySelector("button");

        addBtn.addEventListener("click", ()=>{
          const v = Math.max(1, Math.floor(Number(qtyInput.value || 1)));
          qtyInput.value = v;

          const vStudent = validateStudent();
          if(!vStudent.ok){ showToast(vStudent.msg); return; }

          if(!canAdd(p.cost, v)){
            showToast(`ç§¯åˆ†ä¸å¤Ÿï¼šåŠ å…¥åä¼šè¶…å‡ºï¼ˆå‰©ä½™ ${money(remainingPoints())} ptsï¼‰ã€‚`);
            return;
          }

          state.cart.set(p.id, (state.cart.get(p.id) || 0) + v);
          renderAll();
          showToast("å·²åŠ å…¥è´­ç‰©è½¦ âœ…");
        });

        productList.appendChild(card);
      });
    }

    function renderCart(){
      cartEl.innerHTML = "";
      const items = cartItems();
      cartCount.textContent = `${items.length} ç§`;

      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "note";
        empty.textContent = "è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„ï½å¿«å»é€‰ä¸ªç¤¼ç‰©å§ ğŸ";
        cartEl.appendChild(empty);
        return;
      }

      items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div class="left">
            <div><b>${it.name}</b></div>
            <div class="small">å•ä»·ï¼š${money(it.cost)} ptsï½œæ•°é‡ï¼š${money(it.qty)}</div>
          </div>
          <div class="right">
            <div><b>${money(it.subtotal)}</b> <span class="rm">pts</span></div>
            <button class="remove secondary" type="button">ğŸ—‘ï¸ ç§»é™¤</button>
          </div>
        `;
        row.querySelector("button.remove").addEventListener("click", ()=>{
          state.cart.delete(it.id);
          renderAll();
          showToast("å·²ç§»é™¤ ğŸ§¹");
        });
        cartEl.appendChild(row);
      });
    }

    function renderKPIs(){
      const pts = getStudentPoints();
      const spent = cartTotal();
      const rem = pts - spent;

      kpiAvailable.textContent = money(pts);
      kpiSpent.textContent = money(spent);

      kpiRemaining.textContent = money(rem);
      kpiRemaining.classList.remove("ok","warn","bad");
      if(rem >= 0) kpiRemaining.classList.add(rem === 0 ? "warn" : "ok");
      else kpiRemaining.classList.add("bad");

      btnReview.disabled = !(validateStudent().ok) || cartItems().length === 0 || rem < 0;
    }

    function renderAll(){
      renderKPIs();
      renderCart();
      btnCopy.disabled = !state.lastOrderText;
    }

    // ====== storage ======
    const STORAGE_KEY = "points_shop_2025_v1";

    function save(){
      const payload = {
        student: {
          name: studentName.value.trim(),
          level: studentLevel.value,
          points: getStudentPoints(),
          note: studentNote.value.trim(),
        },
        cart: Array.from(state.cart.entries()),
        lastOrderText: state.lastOrderText
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      showToast("å·²ä¿å­˜ âœ…");
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ showToast("æ²¡æœ‰æ‰¾åˆ°ä¸Šæ¬¡èµ„æ–™"); return; }
      try{
        const payload = JSON.parse(raw);
        studentName.value = payload.student?.name || "";
        studentLevel.value = payload.student?.level || LEVELS_2025[0];
        studentPoints.value = payload.student?.points ?? 0;
        studentNote.value = payload.student?.note || "";
        state.cart = new Map(payload.cart || []);
        state.lastOrderText = payload.lastOrderText || "";
        renderAll();
        showToast("å·²è¯»å– âœ…");
      }catch{
        showToast("è¯»å–å¤±è´¥ï¼šèµ„æ–™æ ¼å¼é”™è¯¯");
      }
    }

    function resetAll(){
      studentName.value = "";
      studentLevel.value = LEVELS_2025[0];
      studentPoints.value = "";
      studentNote.value = "";
      state.cart.clear();
      state.lastOrderText = "";
      localStorage.removeItem(STORAGE_KEY);
      renderAll();
      showToast("å·²æ¸…ç©º âœ…");
    }

    // ====== confirm & submit ======
    function buildOrderText(){
      const name = studentName.value.trim();
      const level = studentLevel.value;
      const pts = getStudentPoints();
      const note = studentNote.value.trim();
      const items = cartItems();

      const spent = cartTotal();
      const rem = pts - spent;

      const lines = [];
      lines.push("=== ç§¯åˆ†å…‘æ¢è®¢å•ï¼ˆ2025ï¼‰===");
      lines.push(`å­¦ç”Ÿï¼š${name}`);
      lines.push(`å¹´çº§/FORMï¼š${level}`);
      lines.push(`ç§¯åˆ†ï¼š${pts} pts`);
      if(note) lines.push(`å¤‡æ³¨ï¼š${note}`);
      lines.push("");
      lines.push("ã€å•†å“ã€‘");
      items.forEach((it, idx)=>{
        lines.push(`${idx+1}. ${it.name}  x${it.qty}  = ${it.subtotal} pts`);
      });
      lines.push("");
      lines.push(`æ€»è®¡ï¼š${spent} pts`);
      lines.push(`å‰©ä½™ï¼š${rem} pts`);
      lines.push(`æäº¤æ—¶é—´ï¼š${new Date().toLocaleString()}`);
      return lines.join("\n");
    }

    btnReview.addEventListener("click", ()=>{
      const v = validateStudent();
      if(!v.ok){ showToast(v.msg); return; }
      if(cartItems().length === 0){ showToast("è´­ç‰©è½¦æ˜¯ç©ºçš„"); return; }
      if(remainingPoints() < 0){ showToast("ç§¯åˆ†ä¸è¶³ï¼Œè¯·åˆ é™¤éƒ¨åˆ†å•†å“"); return; }

      const spent = cartTotal();
      const rem = remainingPoints();
      confirmMeta.innerHTML = `
        <b>${studentName.value.trim()}</b>ï¼ˆ${studentLevel.value}ï¼‰ï½œ
        å¯ç”¨ <b>${money(getStudentPoints())}</b> ptsï½œ
        æœ¬æ¬¡å…‘æ¢ <b>${money(spent)}</b> ptsï½œ
        å‰©ä½™ <b>${money(rem)}</b> pts
      `;
      confirmSummary.textContent = buildOrderText();
      dlg.showModal();
    });

    btnSubmit.addEventListener("click", (e)=>{
      e.preventDefault();
      state.lastOrderText = buildOrderText();
      save();
      dlg.close();
      showToast("è®¢å•å·²æäº¤ âœ…ï¼ˆå·²ç”Ÿæˆè®¢å•æ‘˜è¦ï¼‰");
      btnCopy.disabled = false;

      state.cart.clear();
      renderAll();
    });

    btnCopy.addEventListener("click", async ()=>{
      if(!state.lastOrderText) return;
      try{
        await navigator.clipboard.writeText(state.lastOrderText);
        showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ ğŸ“‹");
      }catch{
        showToast("å¤åˆ¶å¤±è´¥ï¼šä½ çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ");
      }
    });

    // ====== input listeners ======
    [studentName, studentLevel, studentPoints, studentNote].forEach(el=>{
      el.addEventListener("input", ()=> renderKPIs());
      el.addEventListener("change", ()=> renderKPIs());
    });

    btnSave.addEventListener("click", save);
    btnLoad.addEventListener("click", load);
    btnReset.addEventListener("click", resetAll);

    // ====== init ======
    renderLevels();
    renderProducts();
    renderAll();
  </script>
</body>
</html>
